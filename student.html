<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Student Portal - MACS Schools EA</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Arial, sans-serif';
      background: #f0f4f8;
      min-height: 100vh;
      color: #2c3e50;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }
    .container {
      flex: 1;
      max-width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
    }
    .header {
      background: #3498db;
      color: #ffffff;
      padding: 12px 16px;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 18px;
      margin: 0;
    }
    .menu-toggle {
      background: none;
      border: none;
      color: #ffffff;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      transition: transform 0.3s ease;
    }
    .menu-toggle:hover {
      transform: scale(1.15);
    }
    .menu-content {
      display: none;
      position: absolute;
      top: 48px;
      right: 16px;
      background: #2980b9;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      width: 160px;
      z-index: 1000;
      animation: slideDown 0.3s ease-out;
    }
    .menu-content.active {
      display: block;
    }
    .menu-content a, .menu-content button {
      color: #ffffff;
      padding: 8px 12px;
      text-decoration: none;
      display: block;
      font-size: 14px;
      font-weight: 500;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .menu-content a:hover, .menu-content button:hover {
      background: #1abc9c;
    }
    .main-content {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      width: 100%;
      max-width: 100%;
    }
    .slider {
      position: relative;
      width: 100%;
      margin: 12px auto;
      overflow: hidden;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .slider img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .slider img.active {
      opacity: 1;
      position: relative;
    }
    .slider .slider-text {
      position: absolute;
      bottom: 15px;
      left: 15px;
      color: #ffffff;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 13px;
      display: none;
    }
    .slider .slider-text.active {
      display: block;
    }
    .fees-overview {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 12px 0;
    }
    .fees-overview div {
      background: #ffffff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .fees-overview div#billed {
      background: #1abc9c;
      color: #ffffff;
    }
    .fees-overview div#billed i {
      color: #ffffff;
    }
    .fees-overview div#paid {
      background: #3498db;
      color: #ffffff;
    }
    .fees-overview div#paid i {
      color: #ffffff;
    }
    .fees-overview div#balance {
      background: #e74c3c;
      color: #ffffff;
    }
    .fees-overview div#balance i {
      color: #ffffff;
    }
    .section {
      display: none;
      background: #ffffff;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 12px;
      animation: fadeIn 0.5s ease-in;
      width: 100%;
    }
    .section.active {
      display: block;
    }
    h1 {
      font-size: 22px;
      color: #2980b9;
      margin-bottom: 10px;
      font-weight: 700;
      border-bottom: 3px solid #16a085;
      padding-bottom: 8px;
    }
    h2 {
      color: #c0392b;
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    h3 {
      font-size: 15px;
      color: #2c3e50;
      margin: 10px 0 8px;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
      overflow-x: auto;
      display: block;
    }
    th, td {
      border: 1px solid #dfe6e9;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #3498db;
      color: #ffffff;
      font-weight: 700;
    }
    tr:nth-child(even) {
      background: #ecf0f1;
    }
    tr:nth-child(odd) {
      background: #dfe6e9;
    }
    .announcement-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
      width: 100%;
      max-width: 100%;
    }
    .announcement {
      background: #fef9e7;
      padding: 12px;
      border-radius: 12px;
      border-left: 4px solid #e74c3c;
      transition: transform 0.3s ease;
      width: 100%;
      max-width: 100%;
    }
    .announcement.unread {
      background: #fce4d6;
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.2);
    }
    .announcement:hover {
      transform: translateY(-5px);
    }
    .announcement h4 {
      margin: 0 0 8px;
      color: #2c3e50;
      font-size: 15px;
    }
    .announcement p {
      margin: 6px 0;
      font-size: 13px;
    }
    .announcement .mark-read {
      background: #e74c3c;
      color: #ffffff;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: background 0.3s ease;
      margin-top: 8px;
    }
    .announcement .mark-read:hover {
      background: #c0392b;
    }
    button {
      padding: 8px 16px;
      background: #1abc9c;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: transform 0.3s ease, background 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button:hover {
      background: #16a085;
      transform: scale(1.05);
    }
    .error-message {
      color: #e74c3c;
      font-size: 13px;
      margin: 10px;
      padding: 8px;
      background: #fee4e2;
      border-radius: 6px;
      text-align: center;
      animation: fadeIn 0.5s ease-in;
    }
    .payment-center {
      text-align: center;
      padding: 12px;
      background: #f0f4f8;
      border-radius: 12px;
      border: 2px solid #1abc9c;
      margin-bottom: 10px;
      width: 100%;
    }
    .payment-center h1 {
      font-size: 18px;
      color: #c0392b;
      margin-bottom: 10px;
    }
    .payment-assurance li {
      margin: 8px 0;
      font-size: 13px;
      color: #2c3e50;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .payment-assurance li i {
      color: #27ae60;
      font-size: 14px;
    }
    .profile-info p {
      margin: 8px 0;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .profile-info i {
      color: #e74c3c;
      font-size: 14px;
    }
    .profile-info ul {
      list-style: none;
      margin: 10px 0;
      padding-left: 20px;
    }
    .profile-info li {
      margin: 6px 0;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .profile-info blockquote {
      border-left: 3px solid #f39c12;
      padding-left: 10px;
      margin: 10px 0;
      font-style: italic;
      color: #2c3e50;
    }
    .term-select, .score-type-select {
      margin: 10px 0;
      padding: 8px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #dfe6e9;
      width: 100%;
      max-width: 100%;
      transition: border-color 0.3s ease;
    }
    .term-select:focus, .score-type-select:focus {
      border-color: #e74c3c;
      outline: none;
    }
    .announcements-nav {
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .announcements-nav button {
      background: #3498db;
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 8px;
      color: #ffffff;
    }
    .announcements-nav button.active {
      background: #e74c3c;
    }
    .announcements-nav button:hover {
      background: #2980b9;
    }
    .calendar-section {
      background: #ffffff;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 12px;
      width: 100%;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .calendar-month {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    .calendar-month:hover {
      transform: translateY(-5px);
    }
    .calendar-month h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 8px;
      text-align: center;
      border-bottom: 2px solid #3498db;
      padding-bottom: 5px;
    }
    .calendar-month ul {
      list-style: none;
      font-size: 13px;
    }
    .calendar-month li {
      margin: 6px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .calendar-month li i {
      font-size: 14px;
    }
    .term-event { color: #3498db; }
    .holiday-event { color: #1abc9c; }
    .exam-event { color: #e74c3c; }
    .cocurricular-event { color: #f39c12; }
    footer {
      background: #2c3e50;
      color: #ffffff;
      text-align: center;
      padding: 8px 0;
      font-size: 12px;
      width: 100%;
    }
    footer p {
      margin: 3px 0;
    }
    footer a {
      color: #1abc9c;
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .coming-soon {
      background: #f0f4f8;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 10px;
      border: 2px dashed #1abc9c;
      text-align: center;
      color: #e74c3c;
      font-style: italic;
      font-size: 14px;
    }
    .loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #e74c3c;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      z-index: 2000;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 480px) {
      body {
        font-size: 13px;
      }
      .main-content {
        padding: 8px;
      }
      .section {
        margin: 8px 0;
        padding: 10px;
      }
      .slider img {
        height: 160px;
      }
      .header h1 {
        font-size: 16px;
      }
      .menu-content {
        right: 8px;
        width: 140px;
      }
      .menu-content a, .menu-content button {
        font-size: 13px;
        padding: 6px 10px;
      }
      .profile-info, .payment-center, .announcement {
        padding: 10px;
        margin-bottom: 10px;
      }
      .calendar-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>MACS Schools EA Student Portal</h1>
      <button class="menu-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
      <div class="menu-content" id="menuContent">
        <a href="#" onclick="showSection('profile', hideMenu())">Profile</a>
        <a href="#" onclick="showSection('marks', hideMenu())">Academics</a>
        <a href="#" onclick="showSection('fees', hideMenu())">Fees</a>
        <a href="#" onclick="showSection('payFees', hideMenu())">Pay Fees</a>
        <a href="#" onclick="showSection('announcements', hideMenu())">Announcements</a>
        <a href="#" onclick="showSection('timetables', hideMenu())">Timetables</a>
        <a href="#" onclick="showSection('resources', hideMenu())">Resources</a>
        <a href="#" onclick="showSection('calendar', hideMenu())">Calendar</a>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
    <div class="main-content">
      <div class="slider">
        <img src="https://images.unsplash.com/photo-1497633762265-9d179a990aa6?q=80&w=1470&auto=format&fit=crop" alt="Campus Life" class="active">
        <img src="https://images.unsplash.com/photo-1600585154340-be6161a56a0c?q=80&w=1470&auto=format&fit=crop" alt="Classroom">
        <img src="https://miro.medium.com/v2/resize:fit:1200/1*6Jp3vJWe7VFlFHZ9WhSJng.jpeg" alt="Library">
        <div class="slider-text active" id="sliderText1">Primary Education</div>
        <div class="slider-text" id="sliderText2">STUDENTS PORTAL</div>
        <div class="slider-text" id="sliderText3">MACS SCHOOLS EA</div>
      </div>
      <div id="profile" class="section active">
        <h1>Profile</h1>
        <div class="profile-info">
          <p><i class="fas fa-id-card"></i> Admission Number: <strong id="regNo"></strong></p>
          <p><i class="fas fa-user"></i> Name: <strong id="name"></strong></p>
          <p><i class="fas fa-calendar"></i> Year: <strong id="year">Year in Progress</strong></p>
          <p><i class="fas fa-stream"></i> Stream: <strong id="stream">Stream Details</strong></p>
          <p><i class="fas fa-venus-mars"></i> Gender: <strong id="gender">To Be Updated</strong></p>
          <p><i class="fas fa-hand-holding-usd"></i> Sponsor: <strong id="sponsor">Sponsor Info</strong></p>
          <p><i class="fas fa-users"></i> Parent Name: <strong id="parentName">Parent Details</strong></p>
          <p><i class="fas fa-phone"></i> Parent Phone: <strong id="parentPhone">Contact Pending</strong></p>
          <p><i class="fas fa-envelope"></i> Email: <strong id="email">email@example.com</strong></p>
          <div>
            <h2>AI is Changing Lives</h2>
            <p><i class="fas fa-robot"></i> Imagine a student in a rural Kenyan village using a tablet powered by AI to learn mathematics through interactive lessons tailored to their pace. In Nairobi, AI tools help doctors diagnose diseases faster, saving lives. Farmers in Kisumu use AI apps to predict weather and boost crop yields. Artificial Intelligence is transforming Kenya by making education accessible, healthcare efficient, and agriculture smarter. As a student, you can use AI to explore new subjects, get study tips, or even code your own apps. The future is bright, and AI is opening doors to endless possibilities for you!</p>
          </div>
          <div>
            <h2>Employment Ideas for Your Future</h2>
            <ul>
              <li><i class="fas fa-laptop-code"></i> <strong>Technology</strong>: Learn coding to become a software developer, creating apps or websites for businesses in Kenya’s growing tech scene.</li>
              <li><i class="fas fa-solar-panel"></i> <strong>Renewable Energy</strong>: Study science to work in solar or wind energy, powering homes and schools sustainably.</li>
              <li><i class="fas fa-paint-brush"></i> <strong>Creative Arts</strong>: Explore music, art, or drama to join Kenya’s vibrant creative industry, from film to cultural festivals.</li>
              <li><i class="fas fa-tractor"></i> <strong>Agribusiness</strong>: Combine agriculture with entrepreneurship to start a modern farm or supply chain business.</li>
            </ul>
            <p>Talk to your teachers or career counselor to explore these paths and start preparing today!</p>
          </div>
          <div>
            <h2>Choosing the Best Subject Combinations</h2>
            <p><i class="fas fa-book-open"></i> Under the Competency-Based Curriculum (CBC), choosing subjects is about aligning your interests with your career goals. Here’s how to make smart choices:</p>
            <ul>
              <li><i class="fas fa-check-circle"></i> <strong>Core Subjects</strong>: Master Mathematics, English, and Kiswahili, as they build critical skills for all careers.</li>
              <li><i class="fas fa-brain"></i> <strong>Explore Interests</strong>: Try electives like Creative Arts, Home Science, or Agriculture to discover what excites you.</li>
              <li><i class="fas fa-balance-scale"></i> <strong>Balance Choices</strong>: Combine sciences (e.g., Integrated Science) with humanities (e.g., Social Studies) for versatility.</li>
              <li><i class="fas fa-users"></i> <strong>Seek Guidance</strong>: Discuss with teachers and parents to match subjects with future goals, like engineering or teaching.</li>
            </ul>
            <p>Choose subjects you enjoy but also challenge you to grow. Visit the school counselor for personalized advice.</p>
          </div>
          <div>
            <h2>Hard Work and Motivation</h2>
            <p><i class="fas fa-rocket"></i> Success comes from dedication and a positive mindset. Here are tips to stay motivated:</p>
            <ul>
              <li><i class="fas fa-clock"></i> <strong>Manage Time</strong>: Create a study timetable to balance schoolwork, rest, and play.</li>
              <li><i class="fas fa-star"></i> <strong>Set Goals</strong>: Aim for small, achievable targets, like improving your math score by 10%.</li>
              <li><i class="fas fa-heart"></i> <strong>Stay Positive</strong>: Celebrate small wins and learn from mistakes without giving up.</li>
              <li><i class="fas fa-users-cog"></i> <strong>Seek Support</strong>: Study with friends or ask teachers for help when stuck.</li>
            </ul>
            <blockquote>“The future belongs to those who believe in the beauty of their dreams.” – Eleanor Roosevelt</blockquote>
            <p>Keep pushing forward, and your hard work will pay off!</p>
          </div>
        </div>
        <div class="fees-overview">
          <div id="billed"><i class="fas fa-receipt"></i> Total Billed: <span id="feesTotal">Loading...</span></div>
          <div id="paid"><i class="fas fa-check-circle"></i> Total Paid: <span id="feesPaid">Awaiting Update</span></div>
          <div id="balance"><i class="fas fa-balance-scale"></i> Balance: <span id="feesBalance">Calculating...</span></div>
        </div>
      </div>
      <div id="marks" class="section">
        <h1>Academics</h1>
        <select class="term-select" id="termSelect" onchange="updateMarks()">
          <option value="term1">Term 1</option>
          <option value="term2">Term 2</option>
          <option value="term3">Term 3</option>
        </select>
        <select class="score-type-select" id="scoreTypeSelect" onchange="updateMarks()">
          <option value="cat">CAT Scores</option>
          <option value="exam">Exam Scores</option>
        </select>
        <div>
          <table id="marksTable">
            <thead id="marksTableHead">
              <tr>
                <th>Term</th>
                <th>Subject</th>
                <th>Score</th>
                <th>Grade</th>
                <th>Remarks</th>
              </tr>
            </thead>
            <tbody id="marksBody"></tbody>
          </table>
          <p>Total Marks: <span id="totalMarks">0</span></p>
        </div>
        <button style="background: #3498db;" onclick="downloadMarksPDF('cat')"><i class="fas fa-file-pdf"></i> Download CAT PDF</button>
        <button style="background: #1abc9c;" onclick="downloadMarksPDF('exam')"><i class="fas fa-file-pdf"></i> Download Exam PDF</button>
        <button style="background: #e74c3c;" onclick="downloadFullPDF()"><i class="fas fa-file-pdf"></i> Download Full Report PDF</button>
      </div>
      <div id="fees" class="section">
        <h1>Fees</h1>
        <div>
          <p>Total: <span id="feesTotalFees">Loading...</span></p>
          <p>Paid: <span id="feesPaidFees">Awaiting Update</span></p>
          <p>Balance: <span id="feesBalanceFees">Calculating...</span></p>
          <p>Statement: <span id="feesStatement">Statement in Progress</span></p>
          <table id="transactionsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Payer</th>
                <th>Transaction Code</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="transactionsBody"></tbody>
          </table>
          <button onclick="downloadFeePDF()"><i class="fas fa-file-pdf"></i> Download Fee PDF</button>
        </div>
        <div class="fees-overview">
          <div id="billed"><i class="fas fa-receipt"></i> Total Billed: <span id="feesTotalFeesDisplay">Loading...</span></div>
          <div id="paid"><i class="fas fa-check-circle"></i> Total Paid: <span id="feesPaidFeesDisplay">Awaiting Update</span></div>
          <div id="balance"><i class="fas fa-balance-scale"></i> Balance: <span id="feesBalanceFeesDisplay">Calculating...</span></div>
        </div>
      </div>
      <div id="payFees" class="section">
        <h1>Pay Fees</h1>
        <div class="payment-center">
          <h1>Welcome to MACS Schools EA Fee Payment Centre</h1>
          <p>Make your payments with ease and confidence!</p>
          <ul class="payment-assurance">
            <li><i class="fas fa-clock"></i> Fast Processing</li>
            <li><i class="fas fa-tools"></i> Reliable Service</li>
            <li><i class="fas fa-shield-alt"></i> Trusted Platform</li>
            <li><i class="fas fa-lock"></i> Secure Transactions</li>
            <li><i class="fas fa-headset"></i> 24/7 Support</li>
          </ul>
          <button onclick="window.open('https://payment.intasend.com/pay/b90e1c19-33da-4b7d-a654-c4fb72eb9ea7/', '_blank')"><i class="fas fa-credit-card"></i> Pay Now</button>
          <p>After payment, please contact the Accounts Office to confirm receipt. For issues, visit the office for assistance.</p>
        </div>
        <div class="fees-overview">
          <div id="billed"><i class="fas fa-receipt"></i> Total Billed: <span id="feesTotalPayFees">Loading...</span></div>
          <div id="paid"><i class="fas fa-check-circle"></i> Total Paid: <span id="feesPaidPayFees">Awaiting Update</span></div>
          <div id="balance"><i class="fas fa-balance-scale"></i> Balance: <span id="feesBalancePayFees">Calculating...</span></div>
        </div>
      </div>
      <div id="announcements" class="section">
        <h1>Announcements</h1>
        <div class="announcements-nav">
          <button id="generalBtn" class="active" onclick="showAnnouncements('general')">General</button>
          <button id="individualBtn" onclick="showAnnouncements('individual')">Individual</button>
        </div>
        <div class="announcement-grid" id="announcementsContainer"></div>
      </div>
      <div id="timetables" class="section">
        <h1>Timetables</h1>
        <div>
          <h2>Term 1 Timetable</h2>
          <p>Download or view your timetable for Term 1.</p>
          <button onclick="window.open('https://example.com/timetable.pdf', '_blank')"><i class="fas fa-download"></i> Download</button>
        </div>
        <div class="coming-soon">
          <p><i class="fas fa-clock"></i> More timetables coming soon!</p>
        </div>
      </div>
      <div id="resources" class="section">
        <h1>Resources</h1>
        <div>
          <h2>CBC E-Learning Materials</h2>
          <ul>
            <li><a href="https://www.knec.ac.ke/cbc-materials" target="_blank">CBC Subject Notes</a></li>
            <li><a href="https://www.education.go.ke/cbc-videos" target="_blank">CBC Video Lectures</a></li>
            <li><a href="https://www.kICD.ac.ke/cbc-ebooks" target="_blank">CBC E-Books</a></li>
          </ul>
        </div>
        <div>
          <h2>Library Access</h2>
          <p>Access digital library resources and book physical copies.</p>
          <button onclick="window.open('https://library.macsschoolsea.ac.ke', '_blank')"><i class="fas fa-book"></i> Visit Library</button>
        </div>
      </div>
      <div id="calendar" class="section">
        <h1>2025 School Calendar</h1>
        <div class="calendar-grid">
          <div class="calendar-month">
            <h3>January</h3>
            <ul>
              <li class="term-event"><i class="fas fa-school"></i> Term 1 in Progress (Jan 6 - Apr 4)</li>
            </ul>
          </div>
          <div class="calendar-month">
            <h3>February</h3>
            <ul>
              <li class="term-event"><i class="fas fa-school"></i> Term 1 in Progress</li>
              <li class="holiday-event"><i class="fas fa-calendar-alt"></i> Half-Term Break (Feb 26 - Mar 2)</li>
            </ul>
          </div>
          <div class="calendar-month">
            <h3>March</h3>
            <ul>
              <li class="term-event"><i class="fas fa-school"></i> Term 1 in Progress</li>
              <li class="cocurricular-event"><i class="fas fa-flask"></i> Science Fair (Mar 10 - Mar 14)</li>
            </ul>
          </div>
          <div class="calendar-month">
            <h3>April</h3>
            <ul>
              <li class="holiday-event"><i class="fas fa-calendar-alt"></i> April Holiday (Apr 7 - Apr 25)</li>
              <li class="cocurricular-event"><i class="fas fa-running"></i> Athletics & Cross Country (Apr 7 - Apr 11)</li>
              <li class="term-event"><i class="fas fa-school"></i> Term 2 Starts (Apr 28)</li>
            </ul>
          </div>
          <div class="calendar-month">
            <h3>May</h3>
            <ul>
              <li class="term-event"><i class="fas fa-school"></i> Term 2 in Progress</li>
              <li class="holiday-event"><i class="fas fa-calendar-alt"></i> Labour Day (May 1)</li>
            </ul>
          </div>
          <div class="calendar-month">
            <h3>June</h3>
            <ul>
              <li class="term-event"><i class="fas fa-school"></i> Term 2 in Progress</li>
              <li class="holiday-event"><i class="fas fa-calendar-alt"></i> Madaraka Day (Jun 1)</li>
              <li class="cocurricular-event"><i class="fas fa-briefcase"></i> Career Day (Jun 16 - Jun 20)</li>
              <li class="holiday-event"><i class="fas fa-calendar-alt"></i> Half-Term Break (Jun 25 - Jun 29)</li>
            </ul>
          </div>
          <div class="calendar-month">
            <h3>July</h3>
            <ul>
              <li class="term-event"><i class="fas fa-school"></i> Term 2 in Progress</li>
              <li class="cocurricular-event"><i class="fas fa-trophy"></i> Sports: Soccer, Volleyball, Netball (Jul 26 - Aug 3)</li>
            </ul>
          </div>
          <div class="calendar-month">
            <h3>August</h3>
            <ul>
              <li class="term-event"><i class="fas fa-school"></i> Term 2 Ends (Aug 1)</li>
              <li class="holiday-event"><i class="fas fa-calendar-alt"></i> August Holiday (Aug 4 - Aug 22)</li>
              <li class="cocurricular-event"><i class="fas fa-music"></i> Kenya Music Festival (Aug 4 - Aug 12)</li>
              <li class="cocurricular-event"><i class="fas fa-trophy"></i> FEASSSA Games (Aug 14 - Aug 25)</li>
              <li class="term-event"><i class="fas fa-school"></i> Term 3 Starts (Aug 25)</li>
            </ul>
          </div>
          <div class="calendar-month">
            <h3>September</h3>
            <ul>
              <li class="term-event"><i class="fas fa-school"></i> Term 3 in Progress</li>
              <li class="cocurricular-event"><i class="fas fa-hands-helping"></i> Community Service Week (Sep 15 - Sep 19)</li>
            </ul>
          </div>
          <div class="calendar-month">
            <h3>October</h3>
            <ul>
              <li class="term-event"><i class="fas fa-school"></i> Term 3 in Progress</li>
              <li class="holiday-event"><i class="fas fa-calendar-alt"></i> Mashujaa Day (Oct 20)</li>
              <li class="exam-event"><i class="fas fa-book"></i> Exam Preparation Week (Oct 20 - Oct 24)</li>
              <li class="exam-event"><i class="fas fa-book"></i> KPSEA & KILEA Exams (Oct 27 - Oct 31)</li>
              <li class="holiday-event"><i class="fas fa-calendar-alt"></i> December Holiday Starts (Oct 27)</li>
            </ul>
          </div>
          <div class="calendar-month">
            <h3>November</h3>
            <ul>
              <li class="exam-event"><i class="fas fa-book"></i> KJSEA & KPLEA Exams (Nov 1 - Nov 6)</li>
              <li class="holiday-event"><i class="fas fa-calendar-alt"></i> December Holiday</li>
            </ul>
          </div>
          <div class="calendar-month">
            <h3>December</h3>
            <ul>
              <li class="holiday-event"><i class="fas fa-calendar-alt"></i> December Holiday (Until Jan 2, 2026)</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div id="errorMessage" class="error-message"></div>
    <div class="loader" id="loader"></div>
  </div>
  <footer>
    <p>Contact: <a href="mailto:macsschoolsea@gmail.com">macsschoolsea@gmail.com</a> | Phone: +254 712 345 678</p>
    <p>© 2025 MACS Schools EA. All rights reserved.</p>
  </footer>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDqVIFxRrkNSejRuNY9NPYrMpUShO2Yz7U",
      authDomain: "lifeflow-yhtl6.firebaseapp.com",
      databaseURL: "https://lifeflow-yhtl6-default-rtdb.firebaseio.com",
      projectId: "lifeflow-yhtl6",
      storageBucket: "lifeflow-yhtl6.firebasestorage.app",
      messagingSenderId: "129785956666",
      appId: "1:129785956666:web:541a08bee37c739556a803"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentSection = 'profile';
    let currentSlide = 0;
    const slides = document.querySelectorAll('.slider img');
    const slideTexts = document.querySelectorAll('.slider .slider-text');

    function showSection(section, callback) {
      document.querySelectorAll(".section").forEach(div => div.classList.remove("active"));
      document.getElementById(section).classList.add("active");
      currentSection = section;
      if (callback) callback();
    }

    function showError(message, isSuccess = false) {
      const errorDiv = document.getElementById("errorMessage");
      errorDiv.textContent = message === "Permission denied" ? "Coming soon!" : message;
      errorDiv.style.background = isSuccess ? '#d1fae5' : '#fee4e2';
      errorDiv.style.color = isSuccess ? '#27ae60' : '#e74c3c';
      errorDiv.style.display = "block";
      setTimeout(() => { errorDiv.style.display = "none"; }, 5000);
    }

    function getUserNameByEmail(email, role) {
      return db.ref(`users/${role}`).once("value").then(snapshot => {
        const users = snapshot.val() || {};
        for (let key in users) {
          if (users[key].email === email || users[key].email === email + ".stacc@moke.ac") {
            return users[key].name || email;
          }
        }
        return email.replace(".stacc@moke.ac", "");
      }).catch(() => email.replace(".stacc@moke.ac", ""));
    }

    function toggleMenu() {
      const menuContent = document.getElementById("menuContent");
      menuContent.classList.toggle("active");
    }

    function hideMenu() {
      const menuContent = document.getElementById("menuContent");
      menuContent.classList.remove("active");
    }

    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }

    function getRemark(score) {
      if (isNaN(score)) return "N/A";
      if (score < 39) return "Fail";
      if (score <= 50) return "Fair";
      if (score <= 60) return "Pass";
      if (score <= 69) return "Credit";
      return "Excellent";
    }

    function updateMarks() {
      const loader = document.getElementById("loader");
      loader.style.display = "block";
      const term = document.getElementById("termSelect").value;
      const scoreType = document.getElementById("scoreTypeSelect").value;
      const regNo = localStorage.getItem("regNo").replace(/\//g, "_");
      const studentRef = db.ref("users/students/" + regNo);
      studentRef.once("value", (snapshot) => {
        loader.style.display = "none";
        if (snapshot.exists()) {
          const data = snapshot.val();
          const marksBody = document.getElementById("marksBody");
          marksBody.innerHTML = "";
          const termData = data.marks?.[term] || data.academics?.[term] || {};
          let hasMarks = false;
          let totalMarks = 0;
          let subjectCount = 0;
          const scores = scoreType === "cat" ? termData.cat || {} : termData.exam || {};
          for (const [subject, score] of Object.entries(scores)) {
            const numericScore = parseFloat(score);
            if (!isNaN(numericScore)) {
              hasMarks = true;
              totalMarks += numericScore;
              subjectCount++;
              const grade = termData.grades?.[subject] || termData.grades?.[subject.toLowerCase()] || "TBA";
              const remark = getRemark(numericScore);
              marksBody.innerHTML += `<tr>
                <td>${term.replace("term", "Term ")}</td>
                <td>${subject}</td>
                <td>${score}</td>
                <td>${grade}</td>
                <td>${remark}</td>
              </tr>`;
            }
          }
          if (!hasMarks) {
            marksBody.innerHTML = "<tr><td colspan='5'>No marks recorded yet</td></tr>";
          }
          document.getElementById("totalMarks").textContent = totalMarks.toFixed(2);
        } else {
          showError("Student profile not found.");
        }
      }).catch((error) => {
        loader.style.display = "none";
        showError("Failed to update marks: " + error.message);
      });
    }

    async function downloadMarksPDF(type) {
      const loader = document.getElementById("loader");
      loader.style.display = "block";
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const name = document.getElementById("name").textContent;
      const regNo = document.getElementById("regNo").textContent;
      const stream = document.getElementById("stream").textContent;
      const year = document.getElementById("year").textContent;
      const term = document.getElementById("termSelect").value.replace("term", "Term ");
      const today = new Date().toLocaleDateString();
      const regNoNormalized = localStorage.getItem("regNo").replace(/\//g, "_");
      const studentRef = db.ref("users/students/" + regNoNormalized);
      const logoUrl = "https://cdn-icons-png.flaticon.com/512/2231/2231441.png";

      try {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = logoUrl;
        await new Promise(resolve => { img.onload = resolve; });
        doc.addImage(img, "PNG", 20, 10, 30, 30);
      } catch (error) {
        console.error("Failed to load logo:", error);
      }

      doc.setFont("Helvetica", "bold");
      doc.setFontSize(22);
      doc.setTextColor(52, 152, 219);
      doc.text("MACS Schools EA", 105, 20, { align: "center" });
      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text(`${type.toUpperCase()} Academic Report`, 105, 30, { align: "center" });
      doc.setLineWidth(0.5);
      doc.setDrawColor(52, 152, 219);
      doc.line(20, 35, 190, 35);

      doc.setFont("Helvetica", "normal");
      doc.setFontSize(10);
      doc.text("P.O. Box 443, Nyamira", 20, 45);
      doc.text(`Date: ${today}`, 170, 45, { align: "right" });
      doc.setFontSize(12);
      doc.setFont("Helvetica", "bold");
      doc.text("Student Details", 20, 55);
      doc.setFont("Helvetica", "normal");
      doc.text(`Name: ${name}`, 20, 65);
      doc.text(`Registration Number: ${regNo}`, 20, 72);
      doc.text(`Year: ${year}`, 20, 79);
      doc.text(`Stream: ${stream}`, 20, 86);
      doc.text(`Term: ${term}`, 20, 93);

      const rows = [];
      let total = 0;
      let subjectCount = 0;
      try {
        const snapshot = await studentRef.once("value");
        if (snapshot.exists()) {
          const data = snapshot.val();
          const termKey = document.getElementById("termSelect").value;
          const termData = data.marks?.[termKey] || data.academics?.[termKey] || {};
          const scores = type === "cat" ? termData.cat || {} : termData.exam || {};
          for (const [subject, score] of Object.entries(scores)) {
            const numericScore = parseFloat(score);
            if (!isNaN(numericScore)) {
              total += numericScore;
              subjectCount++;
              const grade = termData.grades?.[subject] || termData.grades?.[subject.toLowerCase()] || "TBA";
              const remark = getRemark(numericScore);
              rows.push([term.replace("term", "Term "), subject, score, grade, remark]);
            }
          }
        }
        if (rows.length > 0) {
          doc.autoTable({
            startY: 100,
            head: [["Term", "Subject", `${type.toUpperCase()} Score`, "Grade", "Remarks"]],
            body: rows,
            theme: 'grid',
            styles: { cellPadding: 3, fontSize: 10, font: "Helvetica", lineColor: [0, 0, 0], lineWidth: 0.1 },
            headStyles: { fillColor: [52, 152, 219], textColor: [255, 255, 255], fontStyle: 'bold' },
            alternateRowStyles: { fillColor: [236, 240, 241] },
            columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 60 }, 2: { cellWidth: 30 }, 3: { cellWidth: 30 }, 4: { cellWidth: 30 } },
          });
          doc.setFontSize(10);
          doc.text(`Total ${type.toUpperCase()} Marks: ${total.toFixed(2)}`, 20, doc.lastAutoTable.finalY + 10);
          doc.text(`Average Score: ${(subjectCount > 0 ? total / subjectCount : 0).toFixed(2)}`, 20, doc.lastAutoTable.finalY + 17);
        } else {
          doc.text(`No ${type.toUpperCase()} marks recorded yet`, 20, 100);
        }
      } catch (error) {
        console.error("PDF Error:", error);
        doc.text("Failed to load marks: " + error.message, 20, 100);
      }

      doc.setFontSize(10);
      doc.setFont("Helvetica", "normal");
      doc.text("Registrar: Mr. Mojo", 20, 270);
      doc.text("Signature: ___________________", 140, 270, { align: "right" });
      doc.text(`Date: ${today}`, 140, 277, { align: "right" });

      doc.save(`${name.replace(/ /g, "_")}_${type.toUpperCase()}_Report.pdf`);
      loader.style.display = "none";
    }

    async function downloadFullPDF() {
      const loader = document.getElementById("loader");
      loader.style.display = "block";
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const name = document.getElementById("name").textContent;
      const regNo = document.getElementById("regNo").textContent;
      const stream = document.getElementById("stream").textContent;
      const year = document.getElementById("year").textContent;
      const term = document.getElementById("termSelect").value.replace("term", "Term ");
      const today = new Date().toLocaleDateString();
      const regNoNormalized = localStorage.getItem("regNo").replace(/\//g, "_");
      const studentRef = db.ref("users/students/" + regNoNormalized);
      const logoUrl = "https://cdn-icons-png.flaticon.com/512/2231/2231441.png";

      try {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = logoUrl;
        await new Promise(resolve => { img.onload = resolve; });
        doc.addImage(img, "PNG", 20, 10, 30, 30);
      } catch (error) {
        console.error("Failed to load logo:", error);
      }

      doc.setFont("Helvetica", "bold");
      doc.setFontSize(22);
      doc.setTextColor(52, 152, 219);
      doc.text("MACS Schools EA", 105, 20, { align: "center" });
      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text("Full Academic Report", 105, 30, { align: "center" });
      doc.setLineWidth(0.5);
      doc.setDrawColor(52, 152, 219);
      doc.line(20, 35, 190, 35);

      doc.setFont("Helvetica", "normal");
      doc.setFontSize(10);
      doc.text("P.O. Box 443, Nyamira", 20, 45);
      doc.text(`Date: ${today}`, 170, 45, { align: "right" });
      doc.setFontSize(12);
      doc.setFont("Helvetica", "bold");
      doc.text("Student Details", 20, 55);
      doc.setFont("Helvetica", "normal");
      doc.text(`Name: ${name}`, 20, 65);
      doc.text(`Registration Number: ${regNo}`, 20, 72);
      doc.text(`Year: ${year}`, 20, 79);
      doc.text(`Stream: ${stream}`, 20, 86);
      doc.text(`Term: ${term}`, 20, 93);

      let startY = 100;
      try {
        const snapshot = await studentRef.once("value");
        if (snapshot.exists()) {
          const data = snapshot.val();
          const termKey = document.getElementById("termSelect").value;
          const termData = data.marks?.[termKey] || data.academics?.[termKey] || {};
          let catTotal = 0, examTotal = 0;
          let catCount = 0, examCount = 0;
          const catRows = [];
          const examRows = [];
          const catScores = termData.cat || {};
          const examScores = termData.exam || {};

          for (const [subject, score] of Object.entries(catScores)) {
            const numericScore = parseFloat(score);
            if (!isNaN(numericScore)) {
              catTotal += numericScore;
              catCount++;
              const grade = termData.grades?.[subject] || termData.grades?.[subject.toLowerCase()] || "TBA";
              const remark = getRemark(numericScore);
              catRows.push([term.replace("term", "Term "), subject, score, grade, remark]);
            }
          }
          for (const [subject, score] of Object.entries(examScores)) {
            const numericScore = parseFloat(score);
            if (!isNaN(numericScore)) {
              examTotal += numericScore;
              examCount++;
              const grade = termData.grades?.[subject] || termData.grades?.[subject.toLowerCase()] || "TBA";
              const remark = getRemark(numericScore);
              examRows.push([term.replace("term", "Term "), subject, score, grade, remark]);
            }
          }

          if (catRows.length > 0) {
            doc.setFont("Helvetica", "bold");
            doc.setFontSize(12);
            doc.text("CAT Scores", 20, startY);
            doc.setFont("Helvetica", "normal");
            doc.autoTable({
              startY: startY + 5,
              head: [["Term", "Subject", "CAT Score", "Grade", "Remarks"]],
              body: catRows,
              theme: 'grid',
              styles: { cellPadding: 3, fontSize: 10, font: "Helvetica", lineColor: [0, 0, 0], lineWidth: 0.1 },
              headStyles: { fillColor: [52, 152, 219], textColor: [255, 255, 255], fontStyle: 'bold' },
              alternateRowStyles: { fillColor: [236, 240, 241] },
              columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 60 }, 2: { cellWidth: 30 }, 3: { cellWidth: 30 }, 4: { cellWidth: 30 } },
            });
            doc.setFontSize(10);
            doc.text(`Total CAT Marks: ${catTotal.toFixed(2)}`, 20, doc.lastAutoTable.finalY + 10);
            doc.text(`Average CAT Score: ${(catCount > 0 ? catTotal / catCount : 0).toFixed(2)}`, 20, doc.lastAutoTable.finalY + 17);
            startY = doc.lastAutoTable.finalY + 25;
          } else {
            doc.text("No CAT marks recorded yet", 20, startY);
            startY += 15;
          }

          if (examRows.length > 0) {
            doc.setFont("Helvetica", "bold");
            doc.setFontSize(12);
            doc.text("Exam Scores", 20, startY);
            doc.setFont("Helvetica", "normal");
            doc.autoTable({
              startY: startY + 5,
              head: [["Term", "Subject", "Exam Score", "Grade", "Remarks"]],
              body: examRows,
              theme: 'grid',
              styles: { cellPadding: 3, fontSize: 10, font: "Helvetica", lineColor: [0, 0, 0], lineWidth: 0.1 },
              headStyles: { fillColor: [52, 152, 219], textColor: [255, 255, 255], fontStyle: 'bold' },
              alternateRowStyles: { fillColor: [236, 240, 241] },
              columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 60 }, 2: { cellWidth: 30 }, 3: { cellWidth: 30 }, 4: { cellWidth: 30 } },
            });
            doc.setFontSize(10);
            doc.text(`Total Exam Marks: ${examTotal.toFixed(2)}`, 20, doc.lastAutoTable.finalY + 10);
            doc.text(`Average Exam Score: ${(examCount > 0 ? examTotal / examCount : 0).toFixed(2)}`, 20, doc.lastAutoTable.finalY + 17);
          } else {
            doc.text("No exam marks recorded yet", 20, startY);
          }
        } else {
          doc.text("Student profile not found.", 20, startY);
        }
      } catch (error) {
        console.error("Full PDF Error:", error);
        doc.text("Failed to load marks: " + error.message, 20, startY);
      }

      doc.setFontSize(10);
      doc.setFont("Helvetica", "normal");
      doc.text("Registrar: Mr. Mojo", 20, 270);
      doc.text("Signature: ___________________", 140, 270, { align: "right" });
      doc.text(`Date: ${today}`, 140, 277, { align: "right" });

      doc.save(`${name.replace(/ /g, "_")}_Full_Academic_Report.pdf`);
      loader.style.display = "none";
    }

    async function downloadFeePDF() {
      const loader = document.getElementById("loader");
      loader.style.display = "block";
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const name = document.getElementById("name").textContent;
      const regNo = document.getElementById("regNo").textContent;
      const today = new Date().toLocaleDateString();
      const total = document.getElementById("feesTotalFees").textContent.replace(/,/g, "");
      const paid = document.getElementById("feesPaidFees").textContent.replace(/,/g, "");
      const balance = document.getElementById("feesBalanceFees").textContent.replace(/,/g, "");
      const statement = document.getElementById("feesStatement").textContent;
      const transactionsBody = document.getElementById("transactionsBody");
      const logoUrl = "https://cdn-icons-png.flaticon.com/512/2231/2231441.png";

      try {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = logoUrl;
        await new Promise(resolve => { img.onload = resolve; });
        doc.addImage(img, "PNG", 20, 10, 30, 30);
      } catch (error) {
        console.error("Failed to load logo:", error);
      }

      doc.setFont("Helvetica", "bold");
      doc.setFontSize(22);
      doc.setTextColor(52, 152, 219);
      doc.text("MACS Schools EA", 105, 20, { align: "center" });
      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text("Fee Statement", 105, 30, { align: "center" });
      doc.setLineWidth(0.5);
      doc.setDrawColor(52, 152, 219);
      doc.line(20, 35, 190, 35);

      doc.setFont("Helvetica", "normal");
      doc.setFontSize(10);
      doc.text("P.O. Box 443, Nyamira", 20, 45);
      doc.text(`Date: ${today}`, 170, 45, { align: "right" });
      doc.setFontSize(12);
      doc.setFont("Helvetica", "bold");
      doc.text("Student Details", 20, 55);
      doc.setFont("Helvetica", "normal");
      doc.text(`Name: ${name}`, 20, 65);
      doc.text(`Registration Number: ${regNo}`, 20, 72);
      doc.text(`Total Fees: ${total}`, 20, 79);
      doc.text(`Paid: ${paid}`, 20, 86);
      doc.text(`Balance: ${balance}`, 20, 93);
      doc.text(`Statement: ${statement}`, 20, 100);

      const rows = [];
      if (transactionsBody.querySelectorAll("tr").length > 0) {
        transactionsBody.querySelectorAll("tr").forEach(row => {
          const cols = Array.from(row.querySelectorAll("td")).map(td => td.textContent);
          rows.push(cols);
        });
        doc.autoTable({
          startY: 110,
          head: [["Date", "Amount", "Method", "Payer", "Transaction Code", "Status"]],
          body: rows,
          theme: 'grid',
          styles: { cellPadding: 3, fontSize: 10, font: "Helvetica", lineColor: [0, 0, 0], lineWidth: 0.1 },
          headStyles: { fillColor: [52, 152, 219], textColor: [255, 255, 255], fontStyle: 'bold' },
          alternateRowStyles: { fillColor: [236, 240, 241] },
          columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 30 }, 2: { cellWidth: 30 }, 3: { cellWidth: 30 }, 4: { cellWidth: 30 }, 5: { cellWidth: 30 } },
        });
      } else {
        doc.text("No transactions recorded yet", 20, 110);
      }

      doc.setFontSize(10);
      doc.setFont("Helvetica", "normal");
      doc.text("Accounts Office", 20, 270);
      doc.text("Signature: ___________________", 140, 270, { align: "right" });
      doc.text("Contact: +254 712 345 678", 140, 277, { align: "right" });

      doc.save(`${name.replace(/ /g, "_")}_Fee_Statement.pdf`);
      loader.style.display = "none";
    }

    function slideShow() {
      if (slides.length === 0 || slideTexts.length === 0) return;
      slides[currentSlide].classList.remove('active');
      slideTexts[currentSlide].classList.remove('active');
      currentSlide = (currentSlide + 1) % slides.length;
      slides[currentSlide].classList.add('active');
      slideTexts[currentSlide].classList.add('active');
    }

    function showAnnouncements(type) {
      const container = document.getElementById("announcementsContainer");
      const generalBtn = document.getElementById("generalBtn");
      const individualBtn = document.getElementById("individualBtn");
      generalBtn.classList.toggle("active", type === "general");
      individualBtn.classList.toggle("active", type === "individual");
      container.innerHTML = "";
      const regNo = localStorage.getItem("regNo").replace(/\//g, "_");
      const announcementsRef = db.ref("announcements/" + (type === "general" ? "general" : regNo));
      announcementsRef.once("value", snapshot => {
        const announcements = snapshot.val() || {};
        let hasAnnouncements = false;
        for (const [id, announcement] of Object.entries(announcements)) {
          hasAnnouncements = true;
          const isUnread = !announcement.read;
          container.innerHTML += `
            <div class="announcement ${isUnread ? 'unread' : ''}" id="announcement-${id}">
              <h4>${announcement.title || "No Title"}</h4>
              <p><strong>Date:</strong> ${announcement.date || "Date TBD"}</p>
              <p>${announcement.message || "No message content"}</p>
              ${isUnread ? `<button class="mark-read" onclick="markAsRead('${id}', '${type}')">Mark as Read</button>` : ""}
            </div>`;
        }
        if (!hasAnnouncements) {
          container.innerHTML = "<p>No announcements available.</p>";
        }
      }).catch(error => {
        showError("Failed to load announcements: " + error.message);
      });
    }

    function markAsRead(id, type) {
      const regNo = localStorage.getItem("regNo").replace(/\//g, "_");
      const announcementRef = db.ref(`announcements/${type === "general" ? "general" : regNo}/${id}`);
      announcementRef.update({ read: true }).then(() => {
        const announcementDiv = document.getElementById(`announcement-${id}`);
        announcementDiv.classList.remove("unread");
        announcementDiv.querySelector(".mark-read")?.remove();
        showError("Announcement marked as read!", true);
      }).catch(error => {
        showError("Failed to mark announcement as read: " + error.message);
      });
    }

    window.onload = function() {
      const userType = localStorage.getItem("userType");
      const regNo = localStorage.getItem("regNo");

      if (userType !== "student" || !regNo) {
        localStorage.clear();
        setTimeout(() => window.location.href = "index.html", 100);
        return;
      }

      document.getElementById("regNo").textContent = regNo.replace(/_/g, "/");

      const loader = document.getElementById("loader");
      loader.style.display = "block";
      const studentRef = db.ref("users/students/" + regNo.replace(/\//g, "_"));
      studentRef.once("value", (snapshot) => {
        loader.style.display = "none";
        if (snapshot.exists()) {
          const data = snapshot.val();
          const profile = data.profile || {};
          document.getElementById("name").textContent = profile.name || data.name || "Student Name";
          document.getElementById("email").textContent = profile.email || "email@example.com";
          document.getElementById("year").textContent = profile.year || data.form?.replace("form", "Year ") || "Year in Progress";
          document.getElementById("stream").textContent = profile.stream || data.stream || "Stream Details";
          document.getElementById("gender").textContent = profile.gender || data.gender || "To Be Updated";
          document.getElementById("sponsor").textContent = data.fees?.sponsor || "Sponsor Info";
          document.getElementById("parentName").textContent = profile.parentName || data.parentName || "Parent Details";
          document.getElementById("parentPhone").textContent = profile.parentPhone || data.parentPhone || "Contact Pending";

          const marksBody = document.getElementById("marksBody");
          marksBody.innerHTML = "";
          const term = document.getElementById("termSelect").value;
          const scoreType = document.getElementById("scoreTypeSelect").value;
          const termData = data.marks?.[term] || data.academics?.[term] || {};
          let hasMarks = false;
          let totalMarks = 0;
          let subjectCount = 0;
          const scores = scoreType === "cat" ? termData.cat || {} : termData.exam || {};
          for (const [subject, score] of Object.entries(scores)) {
            const numericScore = parseFloat(score);
            if (!isNaN(numericScore)) {
              hasMarks = true;
              totalMarks += numericScore;
              subjectCount++;
              const grade = termData.grades?.[subject] || termData.grades?.[subject.toLowerCase()] || "TBA";
              const remark = getRemark(numericScore);
              marksBody.innerHTML += `<tr>
                <td>${term.replace("term", "Term ")}</td>
                <td>${subject}</td>
                <td>${score}</td>
                <td>${grade}</td>
                <td>${remark}</td>
              </tr>`;
            }
          }
          if (!hasMarks) {
            marksBody.innerHTML = "<tr><td colspan='5'>No marks recorded yet</td></tr>";
          }
          document.getElementById("totalMarks").textContent = totalMarks.toFixed(2);

          const feesData = data.fees || {};
          const total = feesData.total || feesData.totalExpected || 0;
          const paidFromDb = feesData.paid || 0;
          const transactions = feesData.transactions || [];
          let totalPaid = paidFromDb;
          if (Array.isArray(transactions)) {
            totalPaid += transactions.reduce((sum, tx) => sum + (tx.amount || 0), 0);
          } else if (typeof transactions === "object") {
            totalPaid += Object.values(transactions).reduce((sum, tx) => sum + (tx.amount || 0), 0);
          }
          const balanceFromDb = feesData.balance !== undefined ? feesData.balance : null;
          const balance = balanceFromDb !== null ? balanceFromDb : Math.max(0, total - totalPaid);
          const statement = feesData.statement || "Statement in Progress";

          const feesElements = [
            "feesTotal", "feesPaid", "feesBalance",
            "feesTotalFees", "feesPaidFees", "feesBalanceFees",
            "feesTotalFeesDisplay", "feesPaidFeesDisplay", "feesBalanceFeesDisplay",
            "feesTotalPayFees", "feesPaidPayFees", "feesBalancePayFees"
          ];
          feesElements.forEach(id => {
            if (id.includes("Total")) document.getElementById(id).textContent = total.toLocaleString();
            else if (id.includes("Paid")) document.getElementById(id).textContent = totalPaid.toLocaleString();
            else if (id.includes("Balance")) document.getElementById(id).textContent = balance.toLocaleString();
          });
          document.getElementById("feesStatement").textContent = statement;

          const transactionsBody = document.getElementById("transactionsBody");
          transactionsBody.innerHTML = "";
          if (Array.isArray(transactions)) {
            transactions.forEach(tx => {
              transactionsBody.innerHTML += `<tr>
                <td>${tx.date || "Date TBD"}</td>
                <td>${tx.amount || "0"}</td>
                <td>${tx.method || "Method TBD"}</td>
                <td>${tx.payer || "Payer TBD"}</td>
                <td>${tx.transactionCode || tx.mpesaCode || "Code TBD"}</td>
                <td>${tx.amount ? "Complete" : "Pending"}</td>
              </tr>`;
            });
          } else if (typeof transactions === "object") {
            Object.values(transactions).forEach(tx => {
              transactionsBody.innerHTML += `<tr>
                <td>${tx.date || "Date TBD"}</td>
                <td>${tx.amount || "0"}</td>
                <td>${tx.method || "Method TBD"}</td>
                <td>${tx.payer || "Payer TBD"}</td>
                <td>${tx.transactionCode || tx.mpesaCode || "Code TBD"}</td>
                <td>${tx.amount ? "Complete" : "Pending"}</td>
              </tr>`;
            });
          }
          if (transactionsBody.innerHTML === "") {
            transactionsBody.innerHTML = "<tr><td colspan='6'>No transactions recorded yet</td></tr>";
          }

          showAnnouncements("general");
        } else {
          showError("Student profile not found.");
        }
      }).catch(error => {
        loader.style.display = "none";
        showError("Failed to load profile: " + error.message);
      });

      setInterval(slideShow, 5000);
    }
  </script>
</body>
</html>